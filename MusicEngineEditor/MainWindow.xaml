<Window x:Class="MusicEngineEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:avalonDock="https://github.com/Dirkster99/AvalonDock"
        xmlns:views="clr-namespace:MusicEngineEditor.Views"
        Title="MusicEngine Editor"
        Height="800" Width="1200"
        MinHeight="500" MinWidth="800"
        Style="{StaticResource DarkWindowStyle}"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized">

    <Window.InputBindings>
        <KeyBinding Key="F5" Command="{Binding RunCommand}"/>
        <KeyBinding Key="F5" Modifiers="Shift" Command="{Binding StopCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveAllCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl+Shift" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl+Shift" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewFileCommand}"/>
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding FindCommand}"/>
        <KeyBinding Key="H" Modifiers="Ctrl" Command="{Binding ReplaceCommand}"/>
        <KeyBinding Key="Escape" Command="{Binding StopCommand}"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" Background="{StaticResource MenuBackgroundBrush}" Padding="4,2">
            <MenuItem Header="_File">
                <MenuItem Header="_New Project..." InputGestureText="Ctrl+Shift+N" Click="NewProject_Click"/>
                <MenuItem Header="_Open Project..." InputGestureText="Ctrl+Shift+O" Click="OpenProject_Click"/>
                <Separator/>
                <MenuItem Header="New _File..." InputGestureText="Ctrl+N" Click="NewFile_Click"/>
                <MenuItem Header="_Save" InputGestureText="Ctrl+S" Click="SaveScript_Click"/>
                <MenuItem Header="Save _All" InputGestureText="Ctrl+Shift+S" Click="SaveAll_Click"/>
                <Separator/>
                <MenuItem Header="Recent Projects" x:Name="RecentProjectsMenu"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" Command="Undo" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="_Redo" Command="Redo" InputGestureText="Ctrl+Y"/>
                <Separator/>
                <MenuItem Header="Cu_t" Command="Cut" InputGestureText="Ctrl+X"/>
                <MenuItem Header="_Copy" Command="Copy" InputGestureText="Ctrl+C"/>
                <MenuItem Header="_Paste" Command="Paste" InputGestureText="Ctrl+V"/>
                <Separator/>
                <MenuItem Header="_Find..." InputGestureText="Ctrl+F" Click="Find_Click"/>
                <MenuItem Header="Find and _Replace..." InputGestureText="Ctrl+H" Click="Replace_Click"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="Project Explorer" IsCheckable="True" IsChecked="True" x:Name="ProjectExplorerMenuItem"/>
                <MenuItem Header="Output" IsCheckable="True" IsChecked="True" x:Name="OutputMenuItem"/>
            </MenuItem>
            <MenuItem Header="_Project">
                <MenuItem Header="_Add New Script..." Click="AddScript_Click"/>
                <MenuItem Header="Import _Audio..." Click="ImportAudio_Click"/>
                <Separator/>
                <MenuItem Header="Add Project _Reference..." Click="AddReference_Click"/>
                <Separator/>
                <MenuItem Header="Project _Settings..." Click="ProjectSettings_Click"/>
            </MenuItem>
            <MenuItem Header="_Run">
                <MenuItem Header="_Run" InputGestureText="F5" Click="RunScript_Click"/>
                <MenuItem Header="_Stop" InputGestureText="Shift+F5" Click="Stop_Click"/>
                <Separator/>
                <MenuItem Header="All Notes _Off" InputGestureText="Esc" Click="Panic_Click"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Documentation" Click="Documentation_Click"/>
                <MenuItem Header="_About" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- Main Toolbar -->
        <Border Grid.Row="1" Background="{StaticResource ToolbarBackgroundBrush}"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <DockPanel Margin="8,6">
                <!-- Left: Project Buttons -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Button Style="{StaticResource IconButtonStyle}" Click="NewProject_Click" ToolTip="New Project (Ctrl+Shift+N)">
                        <TextBlock Text="+" FontSize="16" FontWeight="Bold"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="OpenProject_Click" ToolTip="Open Project (Ctrl+Shift+O)" Margin="2,0,0,0">
                        <TextBlock Text="&#x1F4C2;" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="SaveAll_Click" ToolTip="Save All (Ctrl+Shift+S)" Margin="2,0,0,0">
                        <TextBlock Text="&#x1F4BE;" FontSize="14"/>
                    </Button>

                    <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="12,4"/>

                    <!-- Run Controls -->
                    <Button x:Name="RunButton" Content="Run" Style="{StaticResource RunButtonStyle}" Click="RunScript_Click" ToolTip="Execute Script (F5)"/>
                    <Button Content="Stop" Style="{StaticResource StopButtonStyle}" Click="Stop_Click" ToolTip="Stop (Shift+F5)" Margin="6,0,0,0"/>
                    <Button Style="{StaticResource ToolbarButtonStyle}" Click="Panic_Click" ToolTip="All Notes Off (Esc)" Margin="6,0,0,0">
                        <TextBlock Text="Panic" Foreground="{StaticResource WarningBrush}"/>
                    </Button>
                </StackPanel>

                <!-- Right: Sequencer Status -->
                <Border DockPanel.Dock="Right" Background="{StaticResource HeaderBackgroundBrush}"
                        CornerRadius="4" Padding="12,4" Margin="8,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="BPM" Foreground="{StaticResource SecondaryForegroundBrush}"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBox x:Name="BpmBox" Text="120" Width="45"
                                 Style="{StaticResource InputTextBoxStyle}"
                                 VerticalAlignment="Center"
                                 TextAlignment="Center"
                                 KeyDown="BpmBox_KeyDown"/>

                        <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="12,2"/>

                        <TextBlock Text="Beat" Foreground="{StaticResource SecondaryForegroundBrush}"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock x:Name="BeatDisplay" Text="0.00"
                                   Foreground="{StaticResource BrightForegroundBrush}"
                                   FontWeight="SemiBold" FontFamily="JetBrains Mono, Consolas"
                                   Width="50" VerticalAlignment="Center"/>

                        <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="8,2"/>

                        <TextBlock Text="Patterns" Foreground="{StaticResource SecondaryForegroundBrush}"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock x:Name="PatternCountDisplay" Text="0"
                                   Foreground="{StaticResource BrightForegroundBrush}"
                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <Border/> <!-- Spacer -->
            </DockPanel>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240" MinWidth="180" x:Name="LeftPanelColumn"/>
                <ColumnDefinition Width="1"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Project Explorer -->
            <Border Grid.Column="0" Background="{StaticResource PanelBackgroundBrush}" x:Name="ProjectExplorerPanel">
                <DockPanel>
                    <!-- Panel Header -->
                    <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                            Padding="12,8" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="Project"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}"
                                   FontSize="12"/>
                    </Border>

                    <!-- Project Tree -->
                    <TreeView x:Name="ProjectTree"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="8,4"
                              MouseDoubleClick="ProjectTree_MouseDoubleClick"/>
                </DockPanel>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="1" HorizontalAlignment="Stretch" ResizeDirection="Columns"
                          Background="{StaticResource BorderBrush}"/>

            <!-- Center: Editor + Output -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="3*" MinHeight="150"/>
                    <RowDefinition Height="1"/>
                    <RowDefinition Height="*" MinHeight="100"/>
                </Grid.RowDefinitions>

                <!-- Code Editor Area -->
                <Border Grid.Row="0" Background="{StaticResource EditorBackgroundBrush}">
                    <DockPanel>
                        <!-- Tab Bar -->
                        <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                            <TabControl x:Name="EditorTabs"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        SelectionChanged="EditorTabs_SelectionChanged">
                                <TabControl.ItemContainerStyle>
                                    <Style TargetType="TabItem">
                                        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Padding" Value="0"/>
                                        <Setter Property="Margin" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TabItem">
                                                    <Border x:Name="Border"
                                                            Background="{TemplateBinding Background}"
                                                            BorderThickness="0,0,1,2"
                                                            BorderBrush="{StaticResource BorderBrush}"
                                                            Padding="14,8">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#x1F4C4;" FontSize="12" Margin="0,0,6,0"
                                                                       Foreground="{StaticResource SecondaryForegroundBrush}"/>
                                                            <ContentPresenter ContentSource="Header" VerticalAlignment="Center"/>
                                                            <Button Content="&#x2715;" Margin="10,0,0,0"
                                                                    Background="Transparent"
                                                                    BorderThickness="0"
                                                                    Foreground="{StaticResource SecondaryForegroundBrush}"
                                                                    FontSize="10"
                                                                    Padding="4,2"
                                                                    Cursor="Hand"
                                                                    Click="CloseTab_Click"
                                                                    Tag="{Binding RelativeSource={RelativeSource TemplatedParent}}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </StackPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="{StaticResource EditorBackgroundBrush}"/>
                                                            <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                        </Trigger>
                                                        <MultiTrigger>
                                                            <MultiTrigger.Conditions>
                                                                <Condition Property="IsSelected" Value="False"/>
                                                                <Condition Property="IsMouseOver" Value="True"/>
                                                            </MultiTrigger.Conditions>
                                                            <Setter TargetName="Border" Property="Background" Value="#3C3F41"/>
                                                        </MultiTrigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TabControl.ItemContainerStyle>
                            </TabControl>
                        </Border>

                        <!-- Code Editor -->
                        <avalonedit:TextEditor
                            x:Name="CodeEditor"
                            FontFamily="JetBrains Mono, Cascadia Code, Consolas, Courier New"
                            FontSize="13"
                            ShowLineNumbers="True"
                            Background="{StaticResource EditorBackgroundBrush}"
                            Foreground="{StaticResource ForegroundBrush}"
                            LineNumbersForeground="{StaticResource SecondaryForegroundBrush}"
                            Padding="8,4"
                            VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto"/>
                    </DockPanel>
                </Border>

                <!-- Splitter -->
                <GridSplitter Grid.Row="1" Height="1" HorizontalAlignment="Stretch" ResizeDirection="Rows"
                              Background="{StaticResource BorderBrush}"/>

                <!-- Output Panel -->
                <Border Grid.Row="2" Background="{StaticResource PanelBackgroundBrush}" x:Name="OutputPanel">
                    <DockPanel>
                        <!-- Output Header -->
                        <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                            <DockPanel Margin="0">
                                <Button Content="Clear" Style="{StaticResource ToolbarButtonStyle}"
                                        Click="ClearOutput_Click" DockPanel.Dock="Right"
                                        FontSize="11" Padding="10,6" Margin="4"/>

                                <StackPanel Orientation="Horizontal">
                                    <Border Background="{StaticResource AccentBrush}" CornerRadius="0" Padding="14,8">
                                        <TextBlock Text="Output" FontWeight="SemiBold" Foreground="White" FontSize="11"/>
                                    </Border>
                                    <Border Background="Transparent" Padding="14,8" Cursor="Hand">
                                        <TextBlock Text="Problems" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                                    </Border>
                                </StackPanel>
                            </DockPanel>
                        </Border>

                        <!-- Output Content -->
                        <TextBox x:Name="OutputBox"
                                 Style="{StaticResource OutputTextBoxStyle}"
                                 TextWrapping="NoWrap"
                                 AcceptsReturn="True"/>
                    </DockPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3">
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="8" Height="8" Fill="{StaticResource SuccessBrush}" Margin="0,0,6,0"/>
                    <TextBlock x:Name="StatusText" Text="Ready"/>
                </StackPanel>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="ProjectNameDisplay" Text="No project loaded"
                           Foreground="{StaticResource SecondaryForegroundBrush}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="FileNameDisplay" Text=""/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="CaretPositionDisplay" Text="Ln 1, Col 1" Margin="0,0,16,0"/>
                    <TextBlock Text="UTF-8" Foreground="{StaticResource SecondaryForegroundBrush}"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
