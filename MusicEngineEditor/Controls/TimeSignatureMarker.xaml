<UserControl x:Class="MusicEngineEditor.Controls.TimeSignatureMarker"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:MusicEngineEditor.Controls"
             mc:Ignorable="d"
             d:DesignHeight="40" d:DesignWidth="800"
             Background="{DynamicResource PanelBackgroundBrush}"
             ClipToBounds="True">

    <UserControl.Resources>
        <!-- Time Signature Label Style -->
        <Style x:Key="TimeSignatureLabelStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="3" ShadowDepth="1" Opacity="0.2"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Dropdown Button Style -->
        <Style x:Key="TimeSignatureDropdownStyle" TargetType="ComboBox">
            <Setter Property="Width" Value="60"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="Background" Value="{DynamicResource ControlBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
        </Style>

        <!-- Add Button Style -->
        <Style x:Key="AddTimeSignatureButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource SecondaryForegroundBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource SubtleBorderBrush}"/>
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{DynamicResource AccentBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0"
                Background="{DynamicResource ToolbarBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,3">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title -->
                <TextBlock Grid.Column="0"
                           Text="Time Signature"
                           FontSize="11"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource BrightForegroundBrush}"
                           VerticalAlignment="Center"/>

                <!-- Current Time Signature Display -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="12,0,0,0">
                    <TextBlock Text="Current:"
                               FontSize="10"
                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,4,0"/>
                    <Border Background="{DynamicResource ControlBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="2"
                            Padding="6,2">
                        <TextBlock x:Name="CurrentTimeSignatureText"
                                   Text="4/4"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource AccentBrush}"
                                   VerticalAlignment="Center"/>
                    </Border>
                </StackPanel>

                <!-- Add Time Signature Change -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                    <ComboBox x:Name="TimeSignatureComboBox"
                              Style="{StaticResource TimeSignatureDropdownStyle}"
                              SelectedIndex="0">
                        <ComboBoxItem Content="4/4" Tag="4,4"/>
                        <ComboBoxItem Content="3/4" Tag="3,4"/>
                        <ComboBoxItem Content="2/4" Tag="2,4"/>
                        <ComboBoxItem Content="6/8" Tag="6,8"/>
                        <ComboBoxItem Content="9/8" Tag="9,8"/>
                        <ComboBoxItem Content="12/8" Tag="12,8"/>
                        <ComboBoxItem Content="5/4" Tag="5,4"/>
                        <ComboBoxItem Content="7/8" Tag="7,8"/>
                        <ComboBoxItem Content="7/4" Tag="7,4"/>
                        <ComboBoxItem Content="2/2" Tag="2,2"/>
                        <ComboBoxItem Content="Custom..." Tag="custom"/>
                    </ComboBox>
                    <Button Content="+ Add at Bar"
                            Style="{StaticResource AddTimeSignatureButtonStyle}"
                            Click="AddTimeSignatureAtBar_Click"
                            ToolTip="Add time signature change at current bar"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Time Signature Track Canvas -->
        <Canvas Grid.Row="1"
                x:Name="TimeSignatureCanvas"
                Background="Transparent"
                MouseLeftButtonDown="TimeSignatureCanvas_MouseLeftButtonDown"
                MouseRightButtonDown="TimeSignatureCanvas_MouseRightButtonDown"
                MouseMove="TimeSignatureCanvas_MouseMove"
                MouseLeftButtonUp="TimeSignatureCanvas_MouseLeftButtonUp">

            <!-- Time signature markers are drawn programmatically -->

            <!-- Beat grid lines (subtle) -->
            <Rectangle x:Name="GridPattern"
                       Fill="Transparent"
                       IsHitTestVisible="False"/>

            <!-- Context Menu -->
            <Canvas.ContextMenu>
                <ContextMenu x:Name="TimeSignatureContextMenu">
                    <MenuItem Header="Add 4/4" Click="AddCommonTime_Click"/>
                    <MenuItem Header="Add 3/4" Click="AddWaltzTime_Click"/>
                    <MenuItem Header="Add 6/8" Click="AddCompoundTime_Click"/>
                    <MenuItem Header="Add Custom..." Click="AddCustomTime_Click"/>
                    <Separator/>
                    <MenuItem x:Name="EditTimeSignatureMenuItem" Header="Edit Time Signature..." Click="EditTimeSignature_Click" IsEnabled="False"/>
                    <MenuItem x:Name="DeleteTimeSignatureMenuItem" Header="Delete Time Signature" Click="DeleteTimeSignature_Click" IsEnabled="False"/>
                </ContextMenu>
            </Canvas.ContextMenu>
        </Canvas>

        <!-- Edit Popup -->
        <Popup x:Name="EditPopup"
               PlacementTarget="{Binding ElementName=TimeSignatureCanvas}"
               Placement="Mouse"
               StaysOpen="False"
               AllowsTransparency="True">
            <Border Background="{DynamicResource PopupBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="8"
                    Effect="{DynamicResource PopupDropShadow}">
                <StackPanel>
                    <TextBlock Text="Time Signature"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource ForegroundBrush}"
                               Margin="0,0,0,8"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBox x:Name="NumeratorTextBox"
                                 Width="40"
                                 Height="24"
                                 Text="4"
                                 TextAlignment="Center"
                                 VerticalContentAlignment="Center"
                                 FontSize="12"/>
                        <TextBlock Text="/"
                                   FontSize="14"
                                   Foreground="{DynamicResource ForegroundBrush}"
                                   VerticalAlignment="Center"
                                   Margin="4,0"/>
                        <ComboBox x:Name="DenominatorComboBox"
                                  Width="50"
                                  Height="24"
                                  SelectedIndex="2">
                            <ComboBoxItem Content="1"/>
                            <ComboBoxItem Content="2"/>
                            <ComboBoxItem Content="4"/>
                            <ComboBoxItem Content="8"/>
                            <ComboBoxItem Content="16"/>
                            <ComboBoxItem Content="32"/>
                        </ComboBox>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Right">
                        <Button Content="Cancel"
                                Width="60"
                                Height="24"
                                Click="CancelEdit_Click"
                                Margin="0,0,8,0"/>
                        <Button Content="OK"
                                Width="60"
                                Height="24"
                                Click="ApplyEdit_Click"
                                Background="{DynamicResource AccentBrush}"
                                Foreground="White"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</UserControl>
