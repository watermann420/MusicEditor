<UserControl x:Class="MusicEngineEditor.Controls.UndoHistoryPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:MusicEngineEditor.Controls"
             xmlns:vm="clr-namespace:MusicEngineEditor.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="280"
             Background="{DynamicResource PanelBackgroundBrush}">

    <UserControl.Resources>
        <!-- Bool to Visibility Converter -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <!-- Inverse Bool to Visibility Converter -->
        <local:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter"/>

        <!-- String to Visibility Converter -->
        <local:UndoHistoryStringToVisibilityConverter x:Key="StringToVisConverter"/>

        <!-- Int to Bool Converter -->
        <local:IntToBoolConverter x:Key="IntToBoolConverter"/>

        <!-- Bool to Color Converter -->
        <local:BoolToColorConverter x:Key="BoolToColorConverter"/>

        <!-- History Item Style -->
        <Style x:Key="HistoryItemStyle" TargetType="ListBoxItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Margin" Value="2,1"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Border"
                                Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="4"
                                BorderThickness="1"
                                BorderBrush="Transparent">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Undo items have full opacity, redo items are dimmed -->
                            <DataTrigger Binding="{Binding IsUndoItem}" Value="False">
                                <Setter Property="Opacity" Value="0.6"/>
                            </DataTrigger>
                            <!-- Current position marker -->
                            <DataTrigger Binding="{Binding IsCurrentPosition}" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                                <Setter TargetName="Border" Property="BorderThickness" Value="2"/>
                                <Setter TargetName="Border" Property="Background" Value="#33448AFF"/>
                            </DataTrigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#3C3F41"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource AccentBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Context Menu -->
        <ContextMenu x:Key="HistoryContextMenu">
            <MenuItem Header="Jump to This State"
                      Command="{Binding DataContext.JumpToSelectedStateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      InputGestureText="Enter"/>
            <Separator/>
            <MenuItem Header="Branch from Here"
                      Command="{Binding DataContext.BranchFromHereCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      ToolTip="Create a new branch from this point, discarding redo history"/>
            <Separator/>
            <MenuItem Header="Clear All History"
                      Command="{Binding DataContext.ClearHistoryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      Foreground="{DynamicResource ErrorBrush}"/>
        </ContextMenu>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource HeaderBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Undo History"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Foreground="{DynamicResource BrightForegroundBrush}"
                               VerticalAlignment="Center"/>
                    <Border Background="{DynamicResource AccentBrush}"
                            CornerRadius="8"
                            Padding="6,2"
                            Margin="8,0,0,0">
                        <TextBlock Text="{Binding TotalItems}"
                                   FontSize="10"
                                   FontWeight="Bold"
                                   Foreground="White"/>
                    </Border>
                </StackPanel>

                <!-- Refresh Button -->
                <Button Grid.Column="1"
                        Style="{StaticResource IconButtonStyle}"
                        Command="{Binding RefreshHistoryCommand}"
                        ToolTip="Refresh History"
                        Width="24" Height="24">
                    <TextBlock Text="&#x21BB;" FontSize="12"/>
                </Button>
            </Grid>
        </Border>

        <!-- Undo/Redo Quick Actions -->
        <Border Grid.Row="1"
                Background="{DynamicResource BackgroundBrush}"
                Padding="8,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Undo Button -->
                <Button Grid.Column="0"
                        Content="Undo"
                        Command="{Binding UndoLastCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Padding="8,4"
                        FontSize="11"
                        IsEnabled="{Binding UndoCount, Converter={StaticResource IntToBoolConverter}}"/>

                <!-- Position Indicator -->
                <TextBlock Grid.Column="1"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Margin="8,0"
                           FontSize="11"
                           Foreground="{DynamicResource SecondaryForegroundBrush}">
                    <Run Text="{Binding UndoCount, Mode=OneWay}"/>
                    <Run Text="/"/>
                    <Run Text="{Binding TotalItems, Mode=OneWay}"/>
                </TextBlock>

                <!-- Redo Button -->
                <Button Grid.Column="2"
                        Content="Redo"
                        Command="{Binding RedoLastCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Padding="8,4"
                        FontSize="11"
                        IsEnabled="{Binding RedoCount, Converter={StaticResource IntToBoolConverter}}"/>
            </Grid>
        </Border>

        <!-- History List -->
        <Border Grid.Row="2" Margin="4">
            <!-- Empty State -->
            <Grid>
                <!-- Empty Message -->
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Visibility="{Binding IsEmpty, Converter={StaticResource BoolToVisConverter}}">
                    <TextBlock Text="&#x1F4DD;"
                               FontSize="32"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource SecondaryForegroundBrush}"/>
                    <TextBlock Text="No History Yet"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,4"/>
                    <TextBlock Text="Your undo/redo history will appear here"
                               FontSize="11"
                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               MaxWidth="200"
                               TextAlignment="Center"/>
                </StackPanel>

                <!-- History ListBox -->
                <ListBox ItemsSource="{Binding HistoryItems}"
                         SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                         ItemContainerStyle="{StaticResource HistoryItemStyle}"
                         Background="Transparent"
                         BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         MouseDoubleClick="HistoryList_MouseDoubleClick"
                         ContextMenu="{StaticResource HistoryContextMenu}"
                         Visibility="{Binding IsEmpty, Converter={StaticResource InverseBoolToVisConverter}}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="24"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Icon -->
                                <Border Width="20" Height="20"
                                        CornerRadius="10"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding IsUndoItem, Converter={StaticResource BoolToColorConverter}}"/>
                                    </Border.Background>
                                    <TextBlock Text="{Binding Icon}"
                                               FontSize="10"
                                               FontWeight="Bold"
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Border>

                                <!-- Description -->
                                <StackPanel Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Description}"
                                               FontSize="11"
                                               TextTrimming="CharacterEllipsis"
                                               ToolTip="{Binding Description}"/>
                                    <TextBlock Text="{Binding Category}"
                                               FontSize="9"
                                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                                               Visibility="{Binding Category, Converter={StaticResource StringToVisConverter}}"/>
                                </StackPanel>

                                <!-- Timestamp -->
                                <TextBlock Grid.Column="2"
                                           Text="{Binding RelativeTime}"
                                           FontSize="10"
                                           Foreground="{DynamicResource SecondaryForegroundBrush}"
                                           VerticalAlignment="Center"
                                           Margin="8,0,0,0"/>

                                <!-- Current Position Indicator -->
                                <Border Grid.Column="0" Grid.ColumnSpan="3"
                                        Height="2"
                                        Background="{DynamicResource AccentBrush}"
                                        VerticalAlignment="Bottom"
                                        Margin="-8,-2,-8,0"
                                        Visibility="{Binding IsCurrentPosition, Converter={StaticResource BoolToVisConverter}}"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- Footer with Info -->
        <Border Grid.Row="3"
                Background="{DynamicResource BackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="10,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock FontSize="10"
                           Foreground="{DynamicResource SecondaryForegroundBrush}"
                           VerticalAlignment="Center">
                    <Run Text="{Binding UndoCount, Mode=OneWay, StringFormat='Undo: {0}'}"/>
                    <Run Text=" | "/>
                    <Run Text="{Binding RedoCount, Mode=OneWay, StringFormat='Redo: {0}'}"/>
                </TextBlock>

                <Button Grid.Column="1"
                        Content="Clear"
                        Command="{Binding ClearHistoryCommand}"
                        Style="{StaticResource ToolbarButtonStyle}"
                        FontSize="10"
                        Padding="8,2"
                        Foreground="{DynamicResource SecondaryForegroundBrush}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
